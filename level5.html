<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æµ·ç˜æ¸…æ½”å¤§ä½œæˆ°</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
    background-size: cover;
    overflow: hidden;
    user-select: none;
  }
  #game {
    width: 100%;
    height: 100vh;
    position: relative;
  }
  #turtle {
    position: absolute;
    bottom: 10px;
    left: 20%;
    font-size: 50px;
    z-index: 10;
  }
  .trash {
    position: absolute;
    font-size: 32px;
    cursor: grab;
    user-select: none;
    transition: left 0.1s, top 0.1s;
  }
  #bin {
    position: absolute;
    bottom: 10px;
    left: 70%;
    font-size: 80px;
    z-index: 5;
  }
  #ui {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.85);
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 1.1em;
    z-index: 100;
    user-select: none;
  }
  #instructions {
    position: fixed;
    top: 10px;
    left: 10px;
    max-width: 350px;
    background: rgba(255, 255, 255, 0.85);
    padding: 10px;
    border-radius: 8px;
    font-size: 0.95em;
    z-index: 99;
    user-select: none;
  }
  #result {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    font-size: 2em;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 1000;
    text-align: center;
    padding: 20px;
    user-select: none;
  }
  #result button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1em;
    background: #26a69a;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
</style>
</head>
<body>

<audio id="bgm" loop autoplay>
  <source src="https://cdn.pixabay.com/download/audio/2022/10/13/audio_36871e219a.mp3?filename=soft-beach-ambient-121128.mp3" type="audio/mpeg" />
</audio>

<div id="game">
  <div id="turtle">ğŸ¢</div>
  <div id="bin">ğŸ—‘ï¸</div>

  <div id="instructions">
    ğŸ® éŠæˆ²èªªæ˜ï¼š<br>
    æ‹–æ›³åƒåœ¾ï¼ˆğŸ§´ã€ğŸ¥¤ã€ğŸŸï¼‰åˆ°å³ä¸‹è§’çš„ ğŸ—‘ï¸ åƒåœ¾æ¡¶ä¸­ã€‚<br><br>
    âœ… æˆåŠŸæ¸…ç† <strong>15 å€‹åƒåœ¾</strong> å³å¯ç²å‹ã€‚<br>
    âŒ è‹¥åƒåœ¾æ’ä¸Šæµ·é¾œæˆ–æ‰è½åœ°é¢è¶…é <strong>5 æ¬¡</strong>ï¼ŒéŠæˆ²å¤±æ•—ã€‚<br>
    â±ï¸ é™æ™‚ 45 ç§’ï¼
  </div>

  <div id="ui">
    æ¸…ç†åƒåœ¾ï¼š<span id="score">0</span> / 15<br>
    åœ°é¢å¤±èª¤ï¼š<span id="misses">0</span> / 5<br>
    æ™‚é–“ï¼š<span id="time">45</span> ç§’
  </div>
</div>

<div id="result">
  <div id="message"></div>
  <button onclick="startGame()">å†ç©ä¸€æ¬¡</button>
</div>

<script>
  const game = document.getElementById("game");
  const scoreEl = document.getElementById("score");
  const timeEl = document.getElementById("time");
  const missEl = document.getElementById("misses");
  const result = document.getElementById("result");
  const message = document.getElementById("message");
  const turtle = document.getElementById("turtle");
  const bin = document.getElementById("bin");

  let score = 0;
  let time = 45;
  let misses = 0;
  const TRASH_TARGET = 15;
  const MISS_LIMIT = 5;
  let gameOver = false;
  let gameInterval, timerInterval;

  const trashIcons = ["ğŸ§´", "ğŸ¥¤", "ğŸŸ"];
  const FALL_INTERVAL = 30;
  const TRASH_SIZE = 32;

  // ä¸€æ¬¡åªèƒ½æ‹–ä¸€å€‹åƒåœ¾
  let currentlyDraggingTrash = null;

  // ç”¨ä¾†å­˜æ¯å€‹åƒåœ¾çš„æ‰è½Intervalï¼Œæ–¹ä¾¿å–æ¶ˆ
  let fallIntervals = new Map();

  function spawnTrash() {
    if (gameOver || score >= TRASH_TARGET) return;

    const trash = document.createElement("div");
    trash.className = "trash";
    trash.textContent = trashIcons[Math.floor(Math.random() * trashIcons.length)];
    trash.style.left = Math.random() * (window.innerWidth - TRASH_SIZE) + "px";
    trash.style.top = "0px";
    game.appendChild(trash);

    let fallSpeed = 1 + Math.random() * 2;
    let dragging = false;

    function fall() {
      if (gameOver || dragging) {
        clearInterval(fallIntervals.get(trash));
        fallIntervals.delete(trash);
        return;
      }

      let top = parseFloat(trash.style.top);
      top += fallSpeed;
      trash.style.top = top + "px";

      const trashRect = trash.getBoundingClientRect();
      const turtleRect = turtle.getBoundingClientRect();

      if (
        trashRect.bottom >= turtleRect.top &&
        trashRect.left < turtleRect.right &&
        trashRect.right > turtleRect.left
      ) {
        endGame(false, "åƒåœ¾æ’åˆ°æµ·é¾œäº†ï¼");
        clearInterval(fallIntervals.get(trash));
        fallIntervals.delete(trash);
      }

      if (top > window.innerHeight - TRASH_SIZE) {
        misses++;
        missEl.textContent = misses;
        trash.remove();
        clearInterval(fallIntervals.get(trash));
        fallIntervals.delete(trash);
        if (misses >= MISS_LIMIT) {
          endGame(false, "åƒåœ¾æ‰åœ°ä¸Šå¤ªå¤šæ¬¡äº†ï¼");
        }
      }
    }

    fallIntervals.set(trash, setInterval(fall, FALL_INTERVAL));

    trash.addEventListener("mousedown", (e) => {
      if (gameOver) return;
      if (currentlyDraggingTrash) return; // é™åˆ¶ä¸€æ¬¡åªæ‹–ä¸€å€‹åƒåœ¾
      currentlyDraggingTrash = trash;
      dragging = true;

      // åœæ­¢æ‰è½
      clearInterval(fallIntervals.get(trash));
      fallIntervals.delete(trash);

      const offsetX = e.offsetX;
      const offsetY = e.offsetY;

      function moveAt(pageX, pageY) {
        // é˜²æ­¢æ‹–å‡ºè¦–çª—
        let newX = pageX - offsetX;
        let newY = pageY - offsetY;
        newX = Math.min(window.innerWidth - TRASH_SIZE, Math.max(0, newX));
        newY = Math.min(window.innerHeight - TRASH_SIZE, Math.max(0, newY));
        trash.style.left = newX + "px";
        trash.style.top = newY + "px";
      }

      function onMouseMove(e) {
        moveAt(e.pageX, e.pageY);
      }

      document.addEventListener("mousemove", onMouseMove);

      trash.style.cursor = "grabbing";

      document.addEventListener("mouseup", onMouseUp);

      function onMouseUp(e) {
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);

        trash.style.cursor = "grab";

        const binRect = bin.getBoundingClientRect();
        const trashRect = trash.getBoundingClientRect();

        if (
          trashRect.bottom >= binRect.top &&
          trashRect.left < binRect.right &&
          trashRect.right > binRect.left
        ) {
          // æˆåŠŸä¸Ÿåƒåœ¾æ¡¶ï¼Œåƒåœ¾æ¶ˆå¤±ï¼Œè¨ˆåˆ†+1
          score++;
          scoreEl.textContent = score;
          trash.remove();
          currentlyDraggingTrash = null;

          if (score >= TRASH_TARGET) {
            endGame(true);
          }
        } else {
          // æ”¾é–‹æ²’ä¸Ÿé€²åƒåœ¾æ¡¶ï¼Œç¹¼çºŒæ‰è½
          dragging = false;
          currentlyDraggingTrash = null;

          // ç¹¼çºŒæ‰è½
          fallIntervals.set(trash, setInterval(function () {
            if (gameOver || dragging) {
              clearInterval(fallIntervals.get(trash));
              fallIntervals.delete(trash);
              return;
            }
            let top = parseFloat(trash.style.top);
            top += fallSpeed;
            trash.style.top = top + "px";

            const trashRect = trash.getBoundingClientRect();
            const turtleRect = turtle.getBoundingClientRect();

            if (
              trashRect.bottom >= turtleRect.top &&
              trashRect.left < turtleRect.right &&
              trashRect.right > turtleRect.left
            ) {
              endGame(false, "åƒåœ¾æ’åˆ°æµ·é¾œäº†ï¼");
              clearInterval(fallIntervals.get(trash));
              fallIntervals.delete(trash);
            }

            if (top > window.innerHeight - TRASH_SIZE) {
              misses++;
              missEl.textContent = misses;
              trash.remove();
              clearInterval(fallIntervals.get(trash));
              fallIntervals.delete(trash);
              if (misses >= MISS_LIMIT) {
                endGame(false, "åƒåœ¾æ‰åœ°ä¸Šå¤ªå¤šæ¬¡äº†ï¼");
              }
            }
          }, FALL_INTERVAL));
        }
      }
    });
  }

  function updateTimer() {
    if (gameOver) return;
    time--;
    timeEl.textContent = time;
    if (time <= 0) {
      endGame(score >= TRASH_TARGET, "æ™‚é–“åˆ°äº†ï¼");
    }
  }

  function endGame(won, reason = "") {
    gameOver = true;
    clearInterval(gameInterval);
    clearInterval(timerInterval);
    document.querySelectorAll(".trash").forEach(t => t.remove());
    fallIntervals.forEach((interval) => clearInterval(interval));
    fallIntervals.clear();
    currentlyDraggingTrash = null;

    if (won) {
      message.textContent = "ğŸ‰ æˆåŠŸæ‹¯æ•‘æµ·ç˜ï¼ä½ æ¸…ç†äº† 15 å€‹åƒåœ¾ï¼";
    } else {
      message.textContent = "ğŸ˜¢ æŒ‘æˆ°å¤±æ•—ï¼" + (reason ? " åŸå› ï¼š" + reason : "");
    }

    result.style.display = "flex";
  }

  function startGame() {
    score = 0;
    time = 45;
    misses = 0;
    gameOver = false;
    scoreEl.textContent = score;
    timeEl.textContent = time;
    missEl.textContent = misses;
    result.style.display = "none";
    currentlyDraggingTrash = null;

    gameInterval = setInterval(spawnTrash, 900);
    timerInterval = setInterval(updateTimer, 1000);
  }

  startGame();
</script>

</body>
</html>
